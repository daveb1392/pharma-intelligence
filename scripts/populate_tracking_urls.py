"""
Populate barcode_tracking_urls table with URLs for target barcodes.
Run this once to set up tracking.
"""

import asyncio
from storage.supabase_loader import SupabaseLoader
from utils.logger import get_logger

logger = get_logger()

# Target barcodes from client
TARGET_BARCODES = [
    "7841448001463", "7842228000461", "7848000300095", "7840036009850",
    "7841448004624", "7840653008267", "7840315225537", "7840653001367",
    "7840199115559", "7800060015661", "7840199099781", "7841448000855",
    "7840036103190", "606110992602", "7840315224936", "7840274607801",
    "7840036106047", "7840213269114", "7841134010861", "7841134001609",
    "7840213269121", "7841617002468", "7841106000449", "7840036106030",
    "7840036103282", "7840282031094", "7840036009867", "7800060015685",
    "7840085005230", "7840036005234", "7841106003723", "7840653007413",
    "7840282034637", "7840213000519", "7841106000432", "7841722000892",
    "7842228000744", "7841106001286", "7841134010854", "7840653000629",
    "7840282034088", "7848000300088", "7840653001350", "7840199007786",
    "7841134001630", "7841721000060", "7840653001404", "7840199099798",
    "7841417000848", "7840199088082", "7840653004504", "7840653009134",
    "7840274000046", "650240010538", "7841448000220", "7840653007758",
    "7841106003716", "7842568000152", "7840653000452", "7841448000237",
    "7841106003730", "7841106001279", "7798032935492", "7840282035443",
    "7841134015385", "7840315122423", "7841448000862", "7841134015392",
    "7840085005193", "7840274607665", "7840199116136", "7840315122416",
    "7840653004528", "7840213036778", "7840036103275", "7841722000915",
    "7800060110496", "7840085005216", "7840315225544", "7841134015514",
    "7795356001223", "7840653000773", "7800060414327", "7840213027561",
    "7841141001036", "7840199116020", "7840036009560", "7841134008622",
    "7841134009612", "7840213267394", "7795373001749", "7800063001906",
    "7840213267479", "7800007771193", "7800060414242", "7840085001515",
    "7841617001751", "7842568000800", "7840085004790", "4104480705137",
    "7840036107600", "606110992565", "7840653007086", "7840315225056",
    "7840653007147", "7840036007801", "7841134010090", "7841448001593",
    "7840653007697", "7793640215479", "7841448001579", "7798032935096",
    "7840228103069", "7840199116105", "7840315225094", "7840213261583",
    "7841448000800", "7840199088150", "7841134009926", "7841134009933",
    "7840036102872", "7840036102537", "7770108300656", "7840199086491",
    "7840653004696", "7841448001586", "7840282035085", "7840653005402",
    "7841134010069", "7840315224851", "7840199088167", "7840036009195",
    "7840036102742", "7840199116082", "7840213261576", "7798032935140",
    "7840199086767", "7840213263815", "7841448000794", "7793640215622",
    "7841134010113", "7842568000121", "7840036102544", "7841448001654",
    "7841134010151", "7840653007154", "7793640992516", "7798032935126",
    "7840315225148", "7840213036396", "7702870011379", "7840282034491",
    "7795312108751", "7840653000292", "7840199116112", "7840653007185",
    "7842568000893", "7840036008228", "7840315224974", "7840282034859",
    "7840213029992", "7842568000138", "7841448000817", "7840199086521",
    "7841134008516", "7841722000571", "7840653004443", "7793640002093",
    "7800063000824", "7840315225087", "7800060114449", "7840282034200",
    "7840228103557", "7840213268322", "832896000648", "74312764868",
    "7840465000374", "7848004020012", "7640162324526", "8434767000751",
    "7640162324502", "7848004020029", "7640162328227", "7848004020050",
    "7640162324519", "7841134008790", "7795380043190", "7840213267554",
    "7841722000021", "7841617000013", "7800060113985", "7800007802477",
    "7840199086781", "7840085006640", "7795380043138", "7840213253175",
    "7798011654482", "7840085001317", "7841134013916", "7841448000671",
    "7841417000343", "7840282034019", "7840213259931", "7840199101019",
    "7841134013923", "7840085001966", "7840274607160", "7840199087610",
    "7800060129634", "7840653005945", "7840282033975", "7798011654321",
    "7790375251918", "7842658000093", "7840036105880", "7841448000695",
    "7840653005426", "7840036105897", "7841134015248", "7798011654338",
    "7840213252710", "7841134006956", "7840315224790", "7840213258804",
    "7840315224806", "7790375267018", "7790375267452", "7792183100419",
    "7841141001043", "7841448000343", "7501033960840", "7840228103656",
    "7840213034606", "7790375250386", "7840653000094", "7840653008090",
    "7840213029640", "7798140251101", "7841106003525", "7840036102735",
    "7840036011082", "7795356998653", "7840653004467", "7840213300329",
    "7841721000077", "7840653002494", "7841448002422", "7840036007320",
    "7798140253044", "7841106003495", "7841448002439", "7798140250470",
    "7798140250401", "7840228000757", "7840213029671", "7840036102827",
    "7840213029664", "7842228000393", "7840228103342", "7840653000575",
    "7840036105071", "7840282035313", "7840653009554", "7841134020945",
    "7840213301913", "7840653009523", "7840653009530", "7841134020952",
    "7840213301937", "7840213301500", "7840653009547", "7841134020969",
    "7793640431572", "7840282031421", "7840213029398", "7841141004983",
    "4022679107213", "7841134018331", "7840036106412", "7793640047612",
    "7840213263839", "7792219000027", "8435538404549", "7841134018058",
    "7840036106405", "8435538404518", "7840085005681", "7793640992127",
    "7793640047629", "7840213263884", "7840213266953", "7840213266946",
    "7795338999470", "7792183489880", "7730979097956", "7730979097949",
    "7840199115993", "7840199115986", "7840036105972", "7795338001012",
    "7840036105996", "7841722000595", "7840036105989", "7840213264607",
    "5902020885818", "8032749653089", "8032749653058", "7840213029404",
    "7840213029367", "7800007312082", "7840282035351", "7800060116573",
    "7840653005983", "7840213269329", "7841617000648"
]


async def populate_tracking_urls():
    """
    Query products table for target barcodes and populate tracking URLs table.
    """
    loader = SupabaseLoader()

    logger.info(f"\n{'='*60}")
    logger.info(f"POPULATING BARCODE TRACKING URLS")
    logger.info(f"{'='*60}\n")
    logger.info(f"Target: {len(TARGET_BARCODES)} barcodes\n")

    # Query products with target barcodes
    logger.info("Querying products table for matching barcodes...")
    response = loader.client.table("products").select(
        "pharmacy_source, product_url, barcode, site_code, product_name"
    ).in_("barcode", TARGET_BARCODES).not_.is_("product_url", "null").execute()

    products = response.data if response.data else []
    logger.info(f"Found {len(products)} products\n")

    if not products:
        logger.warning("❌ No products found with target barcodes!")
        logger.info("\nPossible reasons:")
        logger.info("  1. Full scrapers haven't run yet")
        logger.info("  2. These barcodes don't exist in any pharmacy")
        logger.info("\nNext steps:")
        logger.info("  1. Run full scrapers first (Phase 1 + Phase 2)")
        logger.info("  2. Then run this script again")
        return

    # Prepare tracking URLs
    tracking_urls = []
    for product in products:
        tracking_urls.append({
            "pharmacy_source": product["pharmacy_source"],
            "product_url": product["product_url"],
            "site_code": product.get("site_code"),
            "barcode": product.get("barcode"),
        })

    # Insert into barcode_tracking_urls table
    logger.info("Inserting URLs into barcode_tracking_urls table...")
    try:
        result = loader.client.table("barcode_tracking_urls").upsert(
            tracking_urls,
            on_conflict="pharmacy_source,product_url"
        ).execute()

        inserted = len(result.data) if result.data else 0
        logger.info(f"✅ Inserted {inserted} URLs\n")

        # Breakdown by pharmacy
        by_pharmacy = {}
        for url in tracking_urls:
            pharmacy = url["pharmacy_source"]
            by_pharmacy[pharmacy] = by_pharmacy.get(pharmacy, 0) + 1

        logger.info("Breakdown by pharmacy:")
        for pharmacy, count in sorted(by_pharmacy.items()):
            logger.info(f"  {pharmacy}: {count} URLs")

        # Barcode analysis
        found_barcodes = set(p["barcode"] for p in products if p.get("barcode"))
        missing_barcodes = set(TARGET_BARCODES) - found_barcodes

        logger.info(f"\nBarcode coverage:")
        logger.info(f"  Found: {len(found_barcodes)}/{len(TARGET_BARCODES)} ({len(found_barcodes)/len(TARGET_BARCODES)*100:.1f}%)")
        logger.info(f"  Missing: {len(missing_barcodes)}")

        if missing_barcodes and len(missing_barcodes) <= 20:
            logger.info(f"\nMissing barcodes:")
            for barcode in sorted(list(missing_barcodes)):
                logger.info(f"  {barcode}")
        elif missing_barcodes:
            logger.info(f"\nFirst 10 missing barcodes:")
            for barcode in sorted(list(missing_barcodes))[:10]:
                logger.info(f"  {barcode}")
            logger.info(f"  ... and {len(missing_barcodes) - 10} more")

        logger.info(f"\n{'='*60}")
        logger.info("SETUP COMPLETE")
        logger.info(f"{'='*60}")
        logger.info("\nNext steps:")
        logger.info("  1. Test: python -m scrapers.daily_tracker")
        logger.info("  2. Push to GitHub for daily runs")
        logger.info(f"{'='*60}\n")

    except Exception as e:
        logger.error(f"❌ Error inserting URLs: {e}")
        raise


if __name__ == "__main__":
    asyncio.run(populate_tracking_urls())
